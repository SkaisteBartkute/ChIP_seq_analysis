import glob
import os

samples = ["SRR8134484", "SRR8134485"]

input_path = "/scratch/lustre/home/skba0280/Epigenomics_raw_data"

genome_index_dir = "/scratch/lustre/home/skba0280/references/human_genome/human_genome"

adapter_path = "/scratch/lustre/home/skba0280/references/adapters/adapters.fasta"

rule all:
   input:
      expand("temporary1/results/fraction/{sample}.fastq",sample=samples),
      expand("temporary1/results/fastp/{sample}_trimmed.fastq",sample=samples),
      expand("temporary1/results/fastp/{sample}_fastp.html",sample=samples),
      expand("temporary1/results/fastp/{sample}_fastp.json",sample=samples),
      expand("temporary1/results/fastqc/{sample}_fastqc.html",sample=samples),
      expand("temporary1/results/fastqc/{sample}_fastqc.zip",sample=samples),
      expand("temporary1/results/fastqc/{sample}_trimmed_fastqc.html",sample=samples),
      expand("temporary1/results/fastqc/{sample}_trimmed_fastqc.zip",sample=samples),
      expand("temporary1/results/bwa/{sample}.sai",sample=samples),
      expand("temporary1/results/bwa/{sample}.sam",sample=samples),
      expand("temporary1/results/bwa/{sample}.bam",sample=samples),
      expand("temporary1/results/bwa/{sample}_rmdup.bam",sample=samples),
      expand("temporary1/results/bedGraph/{sample}.bedgraph",sample=samples),
      "temporary1/results/merged/merged.bam",
      expand("temporary1/results/{sample}_tagDirectory/tagInfo.txt",sample=samples),
      expand("temporary1/results/{sample}_tagDirectory/superEnhancers.txt",sample=samples),
      expand("temporary1/results/{sample}_tagDirectory/regions.txt",sample=samples),      

rule fraction:
   input:
      fq = lambda wildcards:f"{input_path}/{wildcards.sample}.fastq.gz",
   output:
      fqfrac = "temporary1/results/fraction/{sample}.fastq",
   shell:
      """
      seqtk sample -s100 {input.fq} 20000 > {output.fqfrac}
      """

rule fastp:
   input:
      fq = "temporary1/results/fraction/{sample}.fastq",
   output:
      trimmed = "temporary1/results/fastp/{sample}_trimmed.fastq",
      html = "temporary1/results/fastp/{sample}_fastp.html",
      json = "temporary1/results/fastp/{sample}_fastp.json",
   conda:"envs/preprocess_chipseq.yaml"
   threads:4
   shell:
      """
      fastp -i {input.fq} \
      --thread {threads} \
      --adapter_fasta {adapter_path} \
      -q 25 -l 20 \
      -o {output.trimmed} \
      -h {output.html} \
      -j {output.json}
      """

rule fastqc:
   input:
      fq = "temporary1/results/fraction/{sample}.fastq",
      fq_trim = "temporary1/results/fastp/{sample}_trimmed.fastq",
   output:
      html = "temporary1/results/fastqc/{sample}_fastqc.html",
      zip = "temporary1/results/fastqc/{sample}_fastqc.zip",
      html_trim = "temporary1/results/fastqc/{sample}_trimmed_fastqc.html",
      zip_trim = "temporary1/results/fastqc/{sample}_trimmed_fastqc.zip",
   conda:"envs/preprocess_chipseq.yaml"
   threads:4
   shell:
      """
      fastqc -t {threads} --outdir temporary1/results/fastqc {input.fq} {input.fq_trim}
      """

rule bwa:
   input:
     fq = "temporary1/results/fraction/{sample}.fastq",
   output:
     sai = "temporary1/results/bwa/{sample}.sai",
     sam = "temporary1/results/bwa/{sample}.sam",
     bam = "temporary1/results/bwa/{sample}.bam",
     bam_rmdup = "temporary1/results/bwa/{sample}_rmdup.bam",
   conda:"envs/preprocess_chipseq.yaml"
   threads:4
   shell:
     """
     bwa aln -t {threads} {genome_index_dir} {input.fq} > {output.sai}
     bwa samse {genome_index_dir} {output.sai} {input.fq} > {output.sam}
     samtools view -@ {threads} -F 0x04 -q 30 -b {output.sam} | samtools sort -@ {threads} -o {output.bam}
     samtools markdup -@ {threads} -r -s {output.bam} {output.bam_rmdup}
     """

rule bedGraph:
   input:
     bam = "temporary1/results/bwa/{sample}_rmdup.bam",
   output:
     bedGraph = "temporary1/results/bedGraph/{sample}.bedgraph",
   conda: "envs/preprocess_chipseq.yaml"
   threads:4
   shell:
     """
     samtools index -@ {threads} {input.bam}
     bamCoverage --bam {input.bam} --outFileFormat bedgraph -o {output.bedGraph}
     """

rule merge_bam:
   input:
     expand("temporary1/results/bwa/{sample}_rmdup.bam",sample=samples),
   output:
     "temporary1/results/merged/merged.bam",
   conda:"envs/preprocess_chipseq.yaml"
   threads:4
   shell:
     """
     samtools merge -@ {threads} {output} {input}
     samtools index -@ {threads} {output}
     """

rule makeTagDirectory:
   input:
     bam = "temporary1/results/bwa/{sample}_rmdup.bam",
   output:
     dir = "temporary1/results/{sample}_tagDirectory/tagInfo.txt",
   conda:"envs/preprocess_chipseq.yaml"
   shell:
     """
     makeTagDirectory temporary1/results/{wildcards.sample}_tagDirectory {input.bam}
     """

rule findPeaks:
  input:
    tag = "temporary1/results/{sample}_tagDirectory/tagInfo.txt",
  output:
    enh = "temporary1/results/{sample}_tagDirectory/superEnhancers.txt",
    peaks = "temporary1/results/{sample}_tagDirectory/regions.txt",
  conda:"envs/preprocess_chipseq.yaml"
  shell:
    """
    findPeaks temporary1/results/{wildcards.sample}_tagDirectory -style histone -nfr -o auto 
    findPeaks temporary1/results/{wildcards.sample}_tagDirectory -style super -L 0 -superSlope -1000 -o auto 
    """
